# 300 test with AdapterRemoval+Sickle+bayesHammer+spades
# 300_test_AdaptorRMV+Panda+DAMe.txt

# on DY's macbook pro
cd ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/

###Use AdapterRemoval to trim Illumina sequencing adapters. (there are a few adapters still left in the raw data)
# brew install adapterremoval
# or download from https://github.com/MikkelSchubert/adapterremoval

AdapterRemoval --identify-adapters --file1 A1_S1_L001_R1_001.fastq.gz --file2 A1_S1_L001_R2_001.fastq.gz

AdapterRemoval --file1 A1_S1_L001_R1_001.fastq.gz --file2 A1_S1_L001_R2_001.fastq.gz --basename AdaptermvA1 --trimns
##AdaptermvA1=pool A1_R1 and A1_R2 has Illumina adapter trimmed but NOT paried. 1,279,328 reads (R1+R2) --> 1277258 reads (R1+R2)
AdapterRemoval --file1 A2_S2_L001_R1_001.fastq.gz --file2 A2_S2_L001_R2_001.fastq.gz --basename AdaptermvA2 --trimns
##1,041,856-->1,040,584
AdapterRemoval --file1 A3_S3_L001_R1_001.fastq.gz --file2 A3_S3_L001_R2_001.fastq.gz --basename AdaptermvA3 --trimns
##1,013,076-->1,011,432
AdapterRemoval --file1 B1_S4_L001_R1_001.fastq.gz --file2 B1_S4_L001_R2_001.fastq.gz --basename AdaptermvB1 --trimns
##1,001,468-->1243470
AdapterRemoval --file1 B2_S5_L001_R1_001.fastq.gz --file2 B2_S5_L001_R2_001.fastq.gz --basename AdaptermvB2 --trimns
##1,013,698-->1012564
AdapterRemoval --file1 B3_S6_L001_R1_001.fastq.gz --file2 B3_S6_L001_R2_001.fastq.gz --basename AdaptermvB3 --trimns
##918,310-->916442
AdapterRemoval --file1 C1_S7_L001_R1_001.fastq.gz --file2 C1_S7_L001_R2_001.fastq.gz --basename AdaptermvC1 --trimns
##1,024,364-->1022508
AdapterRemoval --file1 C2_S8_L001_R1_001.fastq.gz --file2 C2_S8_L001_R2_001.fastq.gz --basename AdaptermvC2 --trimns
wc AdaptermvC2.pair1.truncated   # 2281812/2=1140906
##1,144,874 -->1140906
AdapterRemoval --file1 C3_S9_L001_R1_001.fastq.gz --file2 C3_S9_L001_R2_001.fastq.gz --basename AdaptermvC3 --trimns
wc AdaptermvC3.pair1.truncated   # 1857548/2=928774
##930,594 -->928774
AdapterRemoval --file1 D1_S10_L001_R1_001.fastq.gz --file2 D1_S10_L001_R2_001.fastq.gz --basename AdaptermvD1 --trimns
wc AdaptermvD1.pair1.truncated
##1,034,946 -->1033070
AdapterRemoval --file1 D2_S11_L001_R1_001.fastq.gz --file2 D2_S11_L001_R2_001.fastq.gz --basename AdaptermvD2 --trimns
wc AdaptermvD2.pair1.truncated
##1,036,520 -->1030836
AdapterRemoval --file1 D3_S12_L001_R1_001.fastq.gz --file2 D3_S12_L001_R2_001.fastq.gz --basename AdaptermvD3 --trimns
wc AdaptermvD3.pair1.truncated
##1,105,344 -->1101750
AdapterRemoval --file1 E1_S13_L001_R1_001.fastq.gz --file2 E1_S13_L001_R2_001.fastq.gz --basename AdaptermvE1 --trimns
wc AdaptermvE1.pair1.truncated    #1920268/2=960134
##969,864-->960134
AdapterRemoval --file1 E2_S14_L001_R1_001.fastq.gz --file2 E2_S14_L001_R2_001.fastq.gz --basename AdaptermvE2 --trimns
wc AdaptermvE2.pair1.truncated   #1894136/2=947068
##956,718-->947068
AdapterRemoval --file1 E3_S15_L001_R1_001.fastq.gz --file2 E3_S15_L001_R2_001.fastq.gz --basename AdaptermvE3 --trimns
wc AdaptermvE3.pair1.truncated   #2548060/2=1274030
##1,283,704-->1274030
AdapterRemoval --file1 F1_S16_L001_R1_001.fastq.gz --file2 F1_S16_L001_R2_001.fastq.gz --basename AdaptermvF1 --trimns
wc AdaptermvF1.pair1.truncated   #1631736/2=815868
##818,038-->815868
AdapterRemoval --file1 F2_S17_L001_R1_001.fastq.gz --file2 F2_S17_L001_R2_001.fastq.gz --basename AdaptermvF2 --trimns
wc AdaptermvF2.pair1.truncated   #1564420/2=782210
##783,510-->782210
AdapterRemoval --file1 F3_S18_L001_R1_001.fastq.gz --file2 F3_S18_L001_R2_001.fastq.gz --basename AdaptermvF3 --trimns
wc AdaptermvF3.pair1.truncated   #1391256/2=695628
##697,466-->695628

###Sickle  error correction strategies and identified quality trimming
# brew install sickle
# or
# download from https://github.com/najoshi/sickle
    # cd sickle-master
    # make
    # sudo cp sickle /usr/local/bin

sickle -h

cd Documents/300test/2017.4.10/SPAdes
###sickle for A1
sickle pe -f AdaptermvA1.pair1.truncated -r AdaptermvA1.pair2.truncated -o sickle_A1R1.fq -p sickle_A1R2.fq -t sanger -s sickle_SingleA1.fq
##-s sickle_SingleA1.fq:  keep single read （not paired but good sequences), will not be used in DAMe pipeline as we are using twin tags but can be used in genome research.

#PE forward file: AdaptermvA1.pair1.truncated
#PE reverse file: AdaptermvA1.pair2.truncated

#Total input FastQ records: 1277258 (638629 pairs)

#FastQ paired records kept: 1272344 (636172 pairs)
#FastQ single records kept: 2453 (from PE1: 2433, from PE2: 20)
#FastQ paired records discarded: 8 (4 pairs)
#FastQ single records discarded: 2453 (from PE1: 20, from PE2: 2433)

###sickle for A2
sickle pe -f AdaptermvA2.pair1.truncated -r AdaptermvA2.pair2.truncated -o sickle_A2R1.fq -p sickle_A2R2.fq -t sanger -s sickle_SingleA2.fq
#PE forward file: AdaptermvA2.pair1.truncated
#PE reverse file: AdaptermvA2.pair2.truncated

#Total input FastQ records: 1040584 (520292 pairs)

#FastQ paired records kept: 1037964 (518982 pairs)
#FastQ single records kept: 1294 (from PE1: 1265, from PE2: 29)
#FastQ paired records discarded: 32 (16 pairs)
#FastQ single records discarded: 1294 (from PE1: 29, from PE2: 1265)

###sickle for A3
sickle pe -f AdaptermvA3.pair1.truncated -r AdaptermvA3.pair2.truncated -o sickle_A3R1.fq -p sickle_A3R2.fq -t sanger -s sickle_SingleA3.fq
#PE forward file: AdaptermvA3.pair1.truncated
#PE reverse file: AdaptermvA3.pair2.truncated

#Total input FastQ records: 1011432 (505716 pairs)

#FastQ paired records kept: 1008950 (504475 pairs)
#FastQ single records kept: 1228 (from PE1: 1206, from PE2: 22)
#FastQ paired records discarded: 26 (13 pairs)
#FastQ single records discarded: 1228 (from PE1: 22, from PE2: 1206)

###sickle for B1
sickle pe -f AdaptermvB1.pair1.truncated -r AdaptermvB1.pair2.truncated -o sickle_B1R1.fq -p sickle_B1R2.fq -t sanger -s sickle_SingleB1.fq
#PE forward file: AdaptermvB1.pair1.truncated
#PE reverse file: AdaptermvB1.pair2.truncated

#Total input FastQ records: 1243470 (621735 pairs)

#FastQ paired records kept: 1238632 (619316 pairs)
#FastQ single records kept: 2401 (from PE1: 2368, from PE2: 33)
#FastQ paired records discarded: 36 (18 pairs)
#FastQ single records discarded: 2401 (from PE1: 33, from PE2: 2368)

###sickle for B2
sickle pe -f AdaptermvB2.pair1.truncated -r AdaptermvB2.pair2.truncated -o sickle_B2R1.fq -p sickle_B2R2.fq -t sanger -s sickle_SingleB2.fq
#PE forward file: AdaptermvB2.pair1.truncated
#PE reverse file: AdaptermvB2.pair2.truncated

#Total input FastQ records: 1012564 (506282 pairs)

#FastQ paired records kept: 1009558 (504779 pairs)
#FastQ single records kept: 1489 (from PE1: 1460, from PE2: 29)
#FastQ paired records discarded: 28 (14 pairs)
#FastQ single records discarded: 1489 (from PE1: 29, from PE2: 1460)

###sickle for B3
sickle pe -f AdaptermvB3.pair1.truncated -r AdaptermvB3.pair2.truncated -o sickle_B3R1.fq -p sickle_B3R2.fq -t sanger -s sickle_SingleB3.fq
#PE forward file: AdaptermvB3.pair1.truncated
#PE reverse file: AdaptermvB3.pair2.truncated

#Total input FastQ records: 916442 (458221 pairs)

#FastQ paired records kept: 913880 (456940 pairs)
#FastQ single records kept: 1280 (from PE1: 1258, from PE2: 22)
#FastQ paired records discarded: 2 (1 pairs)
#FastQ single records discarded: 1280 (from PE1: 22, from PE2: 1258)

###sickle for C1
sickle pe -f AdaptermvC1.pair1.truncated -r AdaptermvC1.pair2.truncated -o sickle_C1R1.fq -p sickle_C1R2.fq -t sanger -s sickle_SingleC1.fq
#PE forward file: AdaptermvC1.pair1.truncated
#PE reverse file: AdaptermvC1.pair2.truncated

#Total input FastQ records: 1022508 (511254 pairs)

#FastQ paired records kept: 1018438 (509219 pairs)
#FastQ single records kept: 2021 (from PE1: 1994, from PE2: 27)
#FastQ paired records discarded: 28 (14 pairs)
#FastQ single records discarded: 2021 (from PE1: 27, from PE2: 1994)

###sickle for C2
sickle pe -f AdaptermvC2.pair1.truncated -r AdaptermvC2.pair2.truncated -o sickle_C2R1.fq -p sickle_C2R2.fq -t sanger -s sickle_SingleC2.fq
#PE forward file: AdaptermvC2.pair1.truncated
#PE reverse file: AdaptermvC2.pair2.truncated

#Total input FastQ records: 1140906 (570453 pairs)

#FastQ paired records kept: 1134174 (567087 pairs)
#FastQ single records kept: 3363 (from PE1: 3341, from PE2: 22)
#FastQ paired records discarded: 6 (3 pairs)
#FastQ single records discarded: 3363 (from PE1: 22, from PE2: 3341)

###sickle for C3
sickle pe -f AdaptermvC3.pair1.truncated -r AdaptermvC3.pair2.truncated -o sickle_C3R1.fq -p sickle_C3R2.fq -t sanger -s sickle_SingleC3.fq
#PE forward file: AdaptermvC3.pair1.truncated
#PE reverse file: AdaptermvC3.pair2.truncated

#Total input FastQ records: 928774 (464387 pairs)

#FastQ paired records kept: 926584 (463292 pairs)
#FastQ single records kept: 1086 (from PE1: 1071, from PE2: 15)
#FastQ paired records discarded: 18 (9 pairs)
#FastQ single records discarded: 1086 (from PE1: 15, from PE2: 1071)

###sickle for D1
sickle pe -f AdaptermvD1.pair1.truncated -r AdaptermvD1.pair2.truncated -o sickle_D1R1.fq -p sickle_D1R2.fq -t sanger -s sickle_SingleD1.fq
#PE forward file: AdaptermvD1.pair1.truncated
#PE reverse file: AdaptermvD1.pair2.truncated

#Total input FastQ records: 1033070 (516535 pairs)

#FastQ paired records kept: 1029492 (514746 pairs)
#FastQ single records kept: 1769 (from PE1: 1748, from PE2: 21)
#FastQ paired records discarded: 40 (20 pairs)
#FastQ single records discarded: 1769 (from PE1: 21, from PE2: 1748)

###sickle for D2
sickle pe -f AdaptermvD2.pair1.truncated -r AdaptermvD2.pair2.truncated -o sickle_D2R1.fq -p sickle_D2R2.fq -t sanger -s sickle_SingleD2.fq
#PE forward file: AdaptermvD2.pair1.truncated
#PE reverse file: AdaptermvD2.pair2.truncated

#Total input FastQ records: 1030836 (515418 pairs)

#FastQ paired records kept: 1028110 (514055 pairs)
#FastQ single records kept: 1361 (from PE1: 1342, from PE2: 19)
#FastQ paired records discarded: 4 (2 pairs)
#FastQ single records discarded: 1361 (from PE1: 19, from PE2: 1342)

###sickle for D3
sickle pe -f AdaptermvD3.pair1.truncated -r AdaptermvD3.pair2.truncated -o sickle_D3R1.fq -p sickle_D3R2.fq -t sanger -s sickle_SingleD3.fq
#PE forward file: AdaptermvD3.pair1.truncated
#PE reverse file: AdaptermvD3.pair2.truncated

#Total input FastQ records: 1101750 (550875 pairs)

#FastQ paired records kept: 1098812 (549406 pairs)
#FastQ single records kept: 1464 (from PE1: 1444, from PE2: 20)
#FastQ paired records discarded: 10 (5 pairs)
#FastQ single records discarded: 1464 (from PE1: 20, from PE2: 1444)

###sickle for E1
sickle pe -f AdaptermvE1.pair1.truncated -r AdaptermvE1.pair2.truncated -o sickle_E1R1.fq -p sickle_E1R2.fq -t sanger -s sickle_SingleE1.fq
#PE forward file: AdaptermvE1.pair1.truncated
#PE reverse file: AdaptermvE1.pair2.truncated

#Total input FastQ records: 960134 (480067 pairs)

#FastQ paired records kept: 955248 (477624 pairs)
#FastQ single records kept: 2402 (from PE1: 2374, from PE2: 28)
#FastQ paired records discarded: 82 (41 pairs)
#FastQ single records discarded: 2402 (from PE1: 28, from PE2: 2374)

###sickle for E2
sickle pe -f AdaptermvE2.pair1.truncated -r AdaptermvE2.pair2.truncated -o sickle_E2R1.fq -p sickle_E2R2.fq -t sanger -s sickle_SingleE2.fq
#PE forward file: AdaptermvE2.pair1.truncated
#PE reverse file: AdaptermvE2.pair2.truncated

#Total input FastQ records: 947068 (473534 pairs)

#FastQ paired records kept: 944848 (472424 pairs)
#FastQ single records kept: 1099 (from PE1: 1079, from PE2: 20)
#FastQ paired records discarded: 22 (11 pairs)
#FastQ single records discarded: 1099 (from PE1: 20, from PE2: 1079)

###sickle for E3
sickle pe -f AdaptermvE3.pair1.truncated -r AdaptermvE3.pair2.truncated -o sickle_E3R1.fq -p sickle_E3R2.fq -t sanger -s sickle_SingleE3.fq
#PE forward file: AdaptermvE3.pair1.truncated
#PE reverse file: AdaptermvE3.pair2.truncated

#Total input FastQ records: 1274030 (637015 pairs)

#FastQ paired records kept: 1269502 (634751 pairs)
#FastQ single records kept: 2259 (from PE1: 2229, from PE2: 30)
#FastQ paired records discarded: 10 (5 pairs)
#FastQ single records discarded: 2259 (from PE1: 30, from PE2: 2229)

###sickle for F1
sickle pe -f AdaptermvF1.pair1.truncated -r AdaptermvF1.pair2.truncated -o sickle_F1R1.fq -p sickle_F1R2.fq -t sanger -s sickle_SingleF1.fq
#PE forward file: AdaptermvF1.pair1.truncated
#PE reverse file: AdaptermvF1.pair2.truncated

#Total input FastQ records: 815868 (407934 pairs)

#FastQ paired records kept: 812124 (406062 pairs)
#FastQ single records kept: 1826 (from PE1: 1799, from PE2: 27)
#FastQ paired records discarded: 92 (46 pairs)
#FastQ single records discarded: 1826 (from PE1: 27, from PE2: 1799)


###sickle for F2
sickle pe -f AdaptermvF2.pair1.truncated -r AdaptermvF2.pair2.truncated -o sickle_F2R1.fq -p sickle_F2R2.fq -t sanger -s sickle_SingleF2.fq
#PE forward file: AdaptermvF2.pair1.truncated
#PE reverse file: AdaptermvF2.pair2.truncated

#Total input FastQ records: 782210 (391105 pairs)

#FastQ paired records kept: 780630 (390315 pairs)
#FastQ single records kept: 782 (from PE1: 767, from PE2: 15)
#FastQ paired records discarded: 16 (8 pairs)
#FastQ single records discarded: 782 (from PE1: 15, from PE2: 767)

###sickle for F3
sickle pe -f AdaptermvF3.pair1.truncated -r AdaptermvF3.pair2.truncated -o sickle_F3R1.fq -p sickle_F3R2.fq -t sanger -s sickle_SingleF3.fq
#PE forward file: AdaptermvF3.pair1.truncated
#PE reverse file: AdaptermvF3.pair2.truncated

#Total input FastQ records: 695628 (347814 pairs)

#FastQ paired records kept: 693928 (346964 pairs)
#FastQ single records kept: 849 (from PE1: 830, from PE2: 19)
#FastQ paired records discarded: 2 (1 pairs)
#FastQ single records discarded: 849 (from PE1: 19, from PE2: 830)

##########
# remove the AdapterRemoval files
# rm Adaptermv*.*

########################################################################## SPAdes for error correction
################### to do:  test bfc, test spades.py -meta

# download from http://cab.spbu.ru/software/spades/
    # sudo cp -r SPAdes-3.10.1 /usr/local/bin
# or
    # brew install homebrew/science/spades

# A1 to C3 can be pasted at the command line in a single batch
date;spades.py --only-error-correction -1 sickle_A1R1.fq -2 sickle_A1R2.fq -s sickle_SingleA1.fq -o SPAdes_hammerA1 ;date
date;spades.py --only-error-correction -1 sickle_A2R1.fq -2 sickle_A2R2.fq -s sickle_SingleA2.fq -o SPAdes_hammerA2 ;date
date;spades.py --only-error-correction -1 sickle_A3R1.fq -2 sickle_A3R2.fq -s sickle_SingleA3.fq -o SPAdes_hammerA3 ;date
date;spades.py --only-error-correction -1 sickle_B1R1.fq -2 sickle_B1R2.fq -s sickle_SingleB1.fq -o SPAdes_hammerB1 ;date
date;spades.py --only-error-correction -1 sickle_B2R1.fq -2 sickle_B2R2.fq -s sickle_SingleB2.fq -o SPAdes_hammerB2 ;date
date;spades.py --only-error-correction -1 sickle_B3R1.fq -2 sickle_B3R2.fq -s sickle_SingleB3.fq -o SPAdes_hammerB3 ;date
date;spades.py --only-error-correction -1 sickle_C1R1.fq -2 sickle_C1R2.fq -s sickle_SingleC1.fq -o SPAdes_hammerC1 ;date
date;spades.py --only-error-correction -1 sickle_C2R1.fq -2 sickle_C2R2.fq -s sickle_SingleC2.fq -o SPAdes_hammerC2 ;date
date;spades.py --only-error-correction -1 sickle_C3R1.fq -2 sickle_C3R2.fq -s sickle_SingleC3.fq -o SPAdes_hammerC3 ;date
# D1 to F3 can be pasted at the command line in a single batch
date;spades.py --only-error-correction -1 sickle_D1R1.fq -2 sickle_D1R2.fq -s sickle_SingleD1.fq -o SPAdes_hammerD1 ;date
date;spades.py --only-error-correction -1 sickle_D2R1.fq -2 sickle_D2R2.fq -s sickle_SingleD2.fq -o SPAdes_hammerD2 ;date
date;spades.py --only-error-correction -1 sickle_D3R1.fq -2 sickle_D3R2.fq -s sickle_SingleD3.fq -o SPAdes_hammerD3 ;date
date;spades.py --only-error-correction -1 sickle_E1R1.fq -2 sickle_E1R2.fq -s sickle_SingleE1.fq -o SPAdes_hammerE1 ;date
date;spades.py --only-error-correction -1 sickle_E2R1.fq -2 sickle_E2R2.fq -s sickle_SingleE2.fq -o SPAdes_hammerE2 ;date
date;spades.py --only-error-correction -1 sickle_E3R1.fq -2 sickle_E3R2.fq -s sickle_SingleE3.fq -o SPAdes_hammerE3 ;date
date;spades.py --only-error-correction -1 sickle_F1R1.fq -2 sickle_F1R2.fq -s sickle_SingleF1.fq -o SPAdes_hammerF1 ;date
date;spades.py --only-error-correction -1 sickle_F2R1.fq -2 sickle_F2R2.fq -s sickle_SingleF2.fq -o SPAdes_hammerF2 ;date
date;spades.py --only-error-correction -1 sickle_F3R1.fq -2 sickle_F3R2.fq -s sickle_SingleF3.fq -o SPAdes_hammerF3 ;date

##########
# remove the sickle files
# rm sickle_*.fq

############################### PandaSeq  use for read overlapping
# download from https://github.com/neufeld/pandaseq/releases
    # PANDAseq-2.11.pkg
# or
    # brew install homebrew/science/pandaseq

pandaseq -f SPAdes_hammerA1/corrected/sickle_A1R1.00.0_0.cor.fastq.gz -r SPAdes_hammerA1/corrected/sickle_A1R2.00.0_0.cor.fastq.gz -A simple_bayesian -F -N -T 7 -g pandaseq_logA1.txt -w sickle_cor_panda_A1.fastq
pandaseq -f SPAdes_hammerA2/corrected/sickle_A2R1.00.0_0.cor.fastq.gz -r SPAdes_hammerA2/corrected/sickle_A2R2.00.0_0.cor.fastq.gz -A simple_bayesian -F -N -T 7 -g pandaseq_logA2.txt -w sickle_cor_panda_A2.fastq
pandaseq -f SPAdes_hammerA3/corrected/sickle_A3R1.00.0_0.cor.fastq.gz -r SPAdes_hammerA3/corrected/sickle_A3R2.00.0_0.cor.fastq.gz -A simple_bayesian -F -N -T 7 -g pandaseq_logA3.txt -w sickle_cor_panda_A3.fastq
pandaseq -f SPAdes_hammerB1/corrected/sickle_B1R1.00.0_0.cor.fastq.gz -r SPAdes_hammerB1/corrected/sickle_B1R2.00.0_0.cor.fastq.gz -A simple_bayesian -F -N -T 7 -g pandaseq_logB1.txt -w sickle_cor_panda_B1.fastq
pandaseq -f SPAdes_hammerB2/corrected/sickle_B2R1.00.0_0.cor.fastq.gz -r SPAdes_hammerB2/corrected/sickle_B2R2.00.0_0.cor.fastq.gz -A simple_bayesian -F -N -T 7 -g pandaseq_logB2.txt -w sickle_cor_panda_B2.fastq
pandaseq -f SPAdes_hammerB3/corrected/sickle_B3R1.00.0_0.cor.fastq.gz -r SPAdes_hammerB3/corrected/sickle_B3R2.00.0_0.cor.fastq.gz -A simple_bayesian -F -N -T 7 -g pandaseq_logB3.txt -w sickle_cor_panda_B3.fastq
pandaseq -f SPAdes_hammerC1/corrected/sickle_C1R1.00.0_0.cor.fastq.gz -r SPAdes_hammerC1/corrected/sickle_C1R2.00.0_0.cor.fastq.gz -A simple_bayesian -F -N -T 7 -g pandaseq_logC1.txt -w sickle_cor_panda_C1.fastq
pandaseq -f SPAdes_hammerC2/corrected/sickle_C2R1.00.0_0.cor.fastq.gz -r SPAdes_hammerC2/corrected/sickle_C2R2.00.0_0.cor.fastq.gz -A simple_bayesian -F -N -T 7 -g pandaseq_logC2.txt -w sickle_cor_panda_C2.fastq
pandaseq -f SPAdes_hammerC3/corrected/sickle_C3R1.00.0_0.cor.fastq.gz -r SPAdes_hammerC3/corrected/sickle_C3R2.00.0_0.cor.fastq.gz -A simple_bayesian -F -N -T 7 -g pandaseq_logC3.txt -w sickle_cor_panda_C3.fastq
pandaseq -f SPAdes_hammerD1/corrected/sickle_D1R1.00.0_0.cor.fastq.gz -r SPAdes_hammerD1/corrected/sickle_D1R2.00.0_0.cor.fastq.gz -A simple_bayesian -F -N -T 7 -g pandaseq_logD1.txt -w sickle_cor_panda_D1.fastq
pandaseq -f SPAdes_hammerD2/corrected/sickle_D2R1.00.0_0.cor.fastq.gz -r SPAdes_hammerD2/corrected/sickle_D2R2.00.0_0.cor.fastq.gz -A simple_bayesian -F -N -T 7 -g pandaseq_logD2.txt -w sickle_cor_panda_D2.fastq
pandaseq -f SPAdes_hammerD3/corrected/sickle_D3R1.00.0_0.cor.fastq.gz -r SPAdes_hammerD3/corrected/sickle_D3R2.00.0_0.cor.fastq.gz -A simple_bayesian -F -N -T 7 -g pandaseq_logD3.txt -w sickle_cor_panda_D3.fastq
pandaseq -f SPAdes_hammerE1/corrected/sickle_E1R1.00.0_0.cor.fastq.gz -r SPAdes_hammerE1/corrected/sickle_E1R2.00.0_0.cor.fastq.gz -A simple_bayesian -F -N -T 7 -g pandaseq_logE1.txt -w sickle_cor_panda_E1.fastq
pandaseq -f SPAdes_hammerE2/corrected/sickle_E2R1.00.0_0.cor.fastq.gz -r SPAdes_hammerE2/corrected/sickle_E2R2.00.0_0.cor.fastq.gz -A simple_bayesian -F -N -T 7 -g pandaseq_logE2.txt -w sickle_cor_panda_E2.fastq
pandaseq -f SPAdes_hammerE3/corrected/sickle_E3R1.00.0_0.cor.fastq.gz -r SPAdes_hammerE3/corrected/sickle_E3R2.00.0_0.cor.fastq.gz -A simple_bayesian -F -N -T 7 -g pandaseq_logE3.txt -w sickle_cor_panda_E3.fastq
pandaseq -f SPAdes_hammerF1/corrected/sickle_F1R1.00.0_0.cor.fastq.gz -r SPAdes_hammerF1/corrected/sickle_F1R2.00.0_0.cor.fastq.gz -A simple_bayesian -F -N -T 7 -g pandaseq_logF1.txt -w sickle_cor_panda_F1.fastq
pandaseq -f SPAdes_hammerF2/corrected/sickle_F2R1.00.0_0.cor.fastq.gz -r SPAdes_hammerF2/corrected/sickle_F2R2.00.0_0.cor.fastq.gz -A simple_bayesian -F -N -T 7 -g pandaseq_logF2.txt -w sickle_cor_panda_F2.fastq
pandaseq -f SPAdes_hammerF3/corrected/sickle_F3R1.00.0_0.cor.fastq.gz -r SPAdes_hammerF3/corrected/sickle_F3R2.00.0_0.cor.fastq.gz -A simple_bayesian -F -N -T 7 -g pandaseq_logF3.txt -w sickle_cor_panda_F3.fastq

# remove SPAdes output
# rm -rf SPAdes_hammer*/
# remove pandseq_log
# rm pandaseq_log*.txt

# gzip sickle_cor_panda_{A,B,C,D,E,F}{1,2,3}.fastq

gzip sickle_cor_panda_A1.fastq
gzip sickle_cor_panda_A2.fastq
gzip sickle_cor_panda_A3.fastq
gzip sickle_cor_panda_B1.fastq
gzip sickle_cor_panda_B2.fastq
gzip sickle_cor_panda_B3.fastq
gzip sickle_cor_panda_C1.fastq
gzip sickle_cor_panda_C2.fastq
gzip sickle_cor_panda_C3.fastq
gzip sickle_cor_panda_D1.fastq
gzip sickle_cor_panda_D2.fastq
gzip sickle_cor_panda_D3.fastq
gzip sickle_cor_panda_E1.fastq
gzip sickle_cor_panda_E2.fastq
gzip sickle_cor_panda_E3.fastq
gzip sickle_cor_panda_F1.fastq
gzip sickle_cor_panda_F2.fastq
gzip sickle_cor_panda_F3.fastq

############################### DAMe - using PCR replicates and read numbers to filter out bad reads

#1. place libraries in different folders
mkdir folder{A,B,C,D,E,F}{1,2,3}
mv sickle_cor_panda_A1.fastq.gz folderA1/
mv sickle_cor_panda_A2.fastq.gz folderA2/
mv sickle_cor_panda_A3.fastq.gz folderA3/
mv sickle_cor_panda_B1.fastq.gz folderB1/
mv sickle_cor_panda_B2.fastq.gz folderB2/
mv sickle_cor_panda_B3.fastq.gz folderB3/
mv sickle_cor_panda_C1.fastq.gz folderC1/
mv sickle_cor_panda_C2.fastq.gz folderC2/
mv sickle_cor_panda_C3.fastq.gz folderC3/
mv sickle_cor_panda_D1.fastq.gz folderD1/
mv sickle_cor_panda_D2.fastq.gz folderD2/
mv sickle_cor_panda_D3.fastq.gz folderD3/
mv sickle_cor_panda_E1.fastq.gz folderE1/
mv sickle_cor_panda_E2.fastq.gz folderE2/
mv sickle_cor_panda_E3.fastq.gz folderE3/
mv sickle_cor_panda_F1.fastq.gz folderF1/
mv sickle_cor_panda_F2.fastq.gz folderF2/
mv sickle_cor_panda_F3.fastq.gz folderF3/


#2. SORT

cd ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/folderA1
python /usr/local/bin/DAMe/bin/sort.py -fq sickle_cor_panda_A1.fastq.gz -p ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Primers_COILeray.txt -t ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Tags_300test_COIA.txt
cd ../folderA2
python /usr/local/bin/DAMe/bin/sort.py -fq sickle_cor_panda_A2.fastq.gz -p ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Primers_COILeray.txt -t ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Tags_300test_COIA.txt
cd ../folderA3
python /usr/local/bin/DAMe/bin/sort.py -fq sickle_cor_panda_A3.fastq.gz -p ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Primers_COILeray.txt -t ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Tags_300test_COIA.txt
cd ../folderB1
python /usr/local/bin/DAMe/bin/sort.py -fq sickle_cor_panda_B1.fastq.gz -p ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Primers_COILeray.txt -t ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Tags_300test_COIA.txt
cd ../folderB2
python /usr/local/bin/DAMe/bin/sort.py -fq sickle_cor_panda_B2.fastq.gz -p ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Primers_COILeray.txt -t ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Tags_300test_COIA.txt
cd ../folderB3
python /usr/local/bin/DAMe/bin/sort.py -fq sickle_cor_panda_B3.fastq.gz -p ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Primers_COILeray.txt -t ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Tags_300test_COIA.txt
cd ../folderC1
python /usr/local/bin/DAMe/bin/sort.py -fq sickle_cor_panda_C1.fastq.gz -p ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Primers_COILeray.txt -t ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Tags_300test_COIA.txt
cd ../folderC2
python /usr/local/bin/DAMe/bin/sort.py -fq sickle_cor_panda_C2.fastq.gz -p ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Primers_COILeray.txt -t ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Tags_300test_COIA.txt
cd ../folderC3
python /usr/local/bin/DAMe/bin/sort.py -fq sickle_cor_panda_C3.fastq.gz -p ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Primers_COILeray.txt -t ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Tags_300test_COIA.txt
cd ../folderD1
python /usr/local/bin/DAMe/bin/sort.py -fq sickle_cor_panda_D1.fastq.gz -p ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Primers_COILeray.txt -t ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Tags_300test_COIA.txt
cd ../folderD2
python /usr/local/bin/DAMe/bin/sort.py -fq sickle_cor_panda_D2.fastq.gz -p ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Primers_COILeray.txt -t ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Tags_300test_COIA.txt
cd ../folderD3
python /usr/local/bin/DAMe/bin/sort.py -fq sickle_cor_panda_D3.fastq.gz -p ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Primers_COILeray.txt -t ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Tags_300test_COIA.txt
cd ../folderE1
python /usr/local/bin/DAMe/bin/sort.py -fq sickle_cor_panda_E1.fastq.gz -p ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Primers_COILeray.txt -t ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Tags_300test_COIA.txt
cd ../folderE2
python /usr/local/bin/DAMe/bin/sort.py -fq sickle_cor_panda_E2.fastq.gz -p ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Primers_COILeray.txt -t ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Tags_300test_COIA.txt
cd ../folderE3
python /usr/local/bin/DAMe/bin/sort.py -fq sickle_cor_panda_E3.fastq.gz -p ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Primers_COILeray.txt -t ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Tags_300test_COIA.txt
cd ../folderF1
python /usr/local/bin/DAMe/bin/sort.py -fq sickle_cor_panda_F1.fastq.gz -p ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Primers_COILeray.txt -t ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Tags_300test_COIA.txt
cd ../folderF2
python /usr/local/bin/DAMe/bin/sort.py -fq sickle_cor_panda_F2.fastq.gz -p ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Primers_COILeray.txt -t ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Tags_300test_COIA.txt
cd ../folderF3
python /usr/local/bin/DAMe/bin/sort.py -fq sickle_cor_panda_F3.fastq.gz -p ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Primers_COILeray.txt -t ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/Tags_300test_COIA.txt


# 3. Place PCR replicates in the same folder and rename to pool{1,2,3} for libraries A, B, C, D; pool{13,14,15} for library E;  pool{16,17,18} for library F
# The three PCR replicate folders (on which sort.py was run) have to be in the same folder (e.g. 'folderA') and named 'pool1', 'pool2', and 'pool3'. No other pool folders

cd ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/
mkdir folder{A,B,C,D,E,F}
mv folderA1 folderA/pool1
mv folderA2 folderA/pool2
mv folderA3 folderA/pool3
mv folderB1 folderB/pool1
mv folderB2 folderB/pool2
mv folderB3 folderB/pool3
mv folderC1 folderC/pool1
mv folderC2 folderC/pool2
mv folderC3 folderC/pool3
mv folderD1 folderD/pool1
mv folderD2 folderD/pool2
mv folderD3 folderD/pool3
mv folderE1 folderE/pool13
mv folderE2 folderE/pool14
mv folderE3 folderE/pool15
mv folderF1 folderF/pool16
mv folderF2 folderF/pool17
mv folderF3 folderF/pool18


# 4. Filter
# Filtering reads with low thresholds to get a feel for the data - 3 PCR replicates (pools), read present in min 2 pools, min 2 reads per pool, min 300 bp.  This step is slow (~ 45 mins per library).

cd ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/
python /usr/local/bin/DAMe/bin/filter.py -h

cd folderA
mkdir Filter_min2PCRs_min2copies_A
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/PSinfo_300test_COIA.txt -x 3 -y 2 -p 3 -t 2 -l 300 -o Filter_min2PCRs_min2copies_A; date

cd ../folderB
mkdir Filter_min2PCRs_min2copies_B
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/PSinfo_300test_COIA.txt -x 3 -y 2 -p 3 -t 2 -l 300 -o Filter_min2PCRs_min2copies_B; date

cd ../folderC
mkdir Filter_min2PCRs_min2copies_C
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/PSinfo_300test_COIA.txt -x 3 -y 2 -p 3 -t 2 -l 300 -o Filter_min2PCRs_min2copies_C; date

cd ../folderD
mkdir Filter_min2PCRs_min2copies_D
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/PSinfo_300test_COIA.txt -x 3 -y 2 -p 3 -t 2 -l 300 -o Filter_min2PCRs_min2copies_D; date

# Using different Psinfo files for libraries E and F.

cd ../folderE
mkdir Filter_min2PCRs_min2copies_E
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/PSinfo_300test_COIE.txt -x 3 -y 2 -p 3 -t 2 -l 300 -o Filter_min2PCRs_min2copies_E; date

cd ../folderF
mkdir Filter_min2PCRs_min2copies_F
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/PSinfo_300test_COIF.txt -x 3 -y 2 -p 3 -t 2 -l 300 -o Filter_min2PCRs_min2copies_F; date

## 5. Prepare the FilteredReads.fna file for Sumaclust clustering. changes the header lines on the fasta file

cd ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/
python /usr/local/bin/DAMe/bin/convertToUSearch.py -h

cd folderA/Filter_min2PCRs_min2copies_A
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
cd ../../folderB/Filter_min2PCRs_min2copies_B
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
cd ../../folderC/Filter_min2PCRs_min2copies_C
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
cd ../../folderD/Filter_min2PCRs_min2copies_D
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
cd ../../folderE/Filter_min2PCRs_min2copies_E
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
cd ../../folderF/Filter_min2PCRs_min2copies_F
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
# python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320 --usearch

## 6. Sumaclust clustering at 96% and 97% and convert Sumaclust output to table format

# sumaclust download from: https://git.metabarcoding.org/obitools/sumaclust/wikis/home
wget https://git.metabarcoding.org/obitools/sumaclust/uploads/69f757c42f2cd45212c587e87c75a00f/sumaclust_v1.0.20.tar.gz
tar -zxvf sumaclust_v1.0.20.tar.gz
cd sumaclust_v1.0.20/
make CC=clang # disables OpenMP, which isn't on macOS

cd ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/
~/src/sumaclust_v1.0.20/sumaclust -h
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -h

## 96% similarity
cd folderA/Filter_min2PCRs_min2copies_A/
~/src/sumaclust_v1.0.20/sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_A_96.txt -blast

cd ../../folderB/Filter_min2PCRs_min2copies_B/
~/src/sumaclust_v1.0.20/sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_B_96.txt -blast

cd ../../folderC/Filter_min2PCRs_min2copies_C/
~/src/sumaclust_v1.0.20/sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_C_96.txt -blast

cd ../../folderD/Filter_min2PCRs_min2copies_D/
~/src/sumaclust_v1.0.20/sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_D_96.txt -blast

cd ../../folderE/Filter_min2PCRs_min2copies_E/
~/src/sumaclust_v1.0.20/sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_E_96.txt -blast

cd ../../folderF/Filter_min2PCRs_min2copies_F/
~/src/sumaclust_v1.0.20/sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_F_96.txt -blast

# 97% similarity
cd ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/

cd folderA/Filter_min2PCRs_min2copies_A/
~/src/sumaclust_v1.0.20/sumaclust -t 0.97 -e FilteredReads.forsumaclust.fna > OTUs_97_sumaclust.fna
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_97_sumaclust.fna -o table_300test_A_97.txt -blast

cd ../../folderB/Filter_min2PCRs_min2copies_B/
~/src/sumaclust_v1.0.20/sumaclust -t 0.97 -e FilteredReads.forsumaclust.fna > OTUs_97_sumaclust.fna
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_97_sumaclust.fna -o table_300test_B_97.txt -blast

cd ../../folderC/Filter_min2PCRs_min2copies_C/
~/src/sumaclust_v1.0.20/sumaclust -t 0.97 -e FilteredReads.forsumaclust.fna > OTUs_97_sumaclust.fna
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_97_sumaclust.fna -o table_300test_C_97.txt -blast

cd ../../folderD/Filter_min2PCRs_min2copies_D/
~/src/sumaclust_v1.0.20/sumaclust -t 0.97 -e FilteredReads.forsumaclust.fna > OTUs_97_sumaclust.fna
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_97_sumaclust.fna -o table_300test_D_97.txt -blast

cd ../../folderE/Filter_min2PCRs_min2copies_E/
~/src/sumaclust_v1.0.20/sumaclust -t 0.97 -e FilteredReads.forsumaclust.fna > OTUs_97_sumaclust.fna
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_97_sumaclust.fna -o table_300test_E_97.txt -blast

cd ../../folderF/Filter_min2PCRs_min2copies_F/
~/src/sumaclust_v1.0.20/sumaclust -t 0.97 -e FilteredReads.forsumaclust.fna > OTUs_97_sumaclust.fna
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_97_sumaclust.fna -o table_300test_F_97.txt -blast

#### ***** Using CROP makes 346 97% OTUs, versus 391 sumaclust 97% OTUs
cd folderA/Filter_min2PCRs_min2copies_A/
~/src/CROP/CROP -i FilteredReads.forsumaclust.fna -o OTUs_CROP_97.out -s -e 2000 -b 185 -z 300 -r 0
# Parms are:
# -r = "This parameter controls the size of the clusters to be considered as “rare”.  –r 0 will yield the best accuracy
# -z < 150,000/avg_seq_length = 150,000/320 bp = 469. let zl < 150000, so set z=300;
# -b = block size = number_of_sequences/50 = 9227/50 = 185;  300Test/folderA/Filter_min2PCRs_min2copies_A/FilteredReads.forsumaclust.fna
# -e = 10*block size = 1850.  2000 (default)
# -s # 97% similarity

#  HOWEVER, CROP takes 5 minutes, and sumaclust takes 10 secs. Also, using CROP needs a need script to convert the CROP OTU map (OTUs_CROP_97.out.cluster.list) and the OTU representative seq list (OTUs_CROP_97.out.cluster.fasta) into an OTU table that preserves the number of original Illumina reads per OTU-sample combination (e.g. table_300test_A_97.txt, which is post sumaclust + tabulateSumaclust.py + OTUs_97_sumaclust.fna)


##### MTB and PC Sanger sequences:  MTBallSpeciesSeqs_20170719.fasta

cd ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/
~/src/sumaclust_v1.0.20/sumaclust -h

~/src/sumaclust_v1.0.20/sumaclust -t 0.98 -e MTBallSpeciesSeqs_20170719.fasta > MTB_OTUs_98_sumaclust.fas
# 261 clusters
~/src/sumaclust_v1.0.20/sumaclust -t 0.97 -e MTBallSpeciesSeqs_20170719.fasta > MTB_OTUs_97_sumaclust.fas
# 254 clusters
~/src/sumaclust_v1.0.20/sumaclust -t 0.96 -e MTBallSpeciesSeqs_20170719.fasta > MTB_OTUs_96_sumaclust.fas
# 252 clusters
~/src/CROP/CROP -i MTBallSpeciesSeqs_20170719.fasta -o MTB_OTUs_CROP_97.out -s -e 60 -b 6 -z 230 -r 0
# 231 clusters

# Parms are:
# -r = "This parameter controls the size of the clusters to be considered as “rare”.  –r 0 will yield the best accuracy
# -z < 150,000/avg_seq_length = 150,000/623 bp = 241. Let zl < 150,000, so set z=230;
# -b = block size = number_of_sequences/50 = 280/50 = 5.6, so set to b=6
# -e = 10*block size = 60.  2000 (default)
# -s # 97% similarity


#########################
7. Choose final filter.py thresholds

cd ~/Xiaoyangmiseqdata/MiSeq_20170410/300Test/
mkdir otutables/
cp folder{A,B,C,D,E,F}/Filter_min2PCRs_min2copies_{A,B,C,D,E,F}/table_300test_{A,B,C,D,E,F}_96.txt ./otutables
cp folder{A,B,C,D,E,F}/Filter_min2PCRs_min2copies_{A,B,C,D,E,F}/table_300test_{A,B,C,D,E,F}_97.txt ./otutables
# insert into an excel table and check for mix-ups, extraction blanks,  positive control, and samples. decide on new thresholds for filtering
# consider using R to read the tables and write to an excel file

# START HERE

##filtering with new thresholds
mkdir Filter_min2PCRs_min10copies_A
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo PSinfo_300test_COIA.txt -x 3 -y 2 -p 3 -t 10 -l 300 -o Filter_min2PCRs_min20copies_A ;date
#2017年 4月14日 星期五 22时02分06秒 CST
#2017年 4月14日 星期五 22时46分19秒 CST
python /usr/local/bin/DAMe/bin/convertToUSearch.py -h
cd Filter_min2PCRs_min10copies_A
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_A_96.txt -blast


mkdir Filter_min2PCRs_min3copies_A
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo PSinfo_300test_COIA.txt -x 3 -y 2 -p 3 -t 3 -l 300 -o Filter_min2PCRs_min3copies_A ;date
#2017年 4月14日 星期五 22时11分11秒 CST
#2017年 4月14日 星期五 22时54分34秒 CST
cd Filter_min2PCRs_min3copies_A
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_A_96.txt -blast


mkdir Filter_min3PCRs_min3copies_A
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo PSinfo_300test_COIA.txt -x 3 -y 3 -p 3 -t 3 -l 300 -o Filter_min3PCRs_min3copies_A ;date
#2017年 4月14日 星期五 23时05分11秒 CST
#2017年 4月14日 星期五 23时46分21秒 CST
cd Filter_min3PCRs_min3copies_A
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna  ###276  OTU
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_A_96.txt -blast


mkdir Filter_min3PCRs_min2copies_A
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo PSinfo_300test_COIA.txt -x 3 -y 3 -p 3 -t 2 -l 300 -o Filter_min3PCRs_min2copies_A ;date
#2017年 5月 5日 星期五 11时10分08秒 CST
#2017年 5月 5日 星期五 11时55分52秒 CST
cd Filter_min3PCRs_min2copies_A
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna  ###301 OTU
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_A_96.txt -blast

mkdir Filter_min3PCRs_min5copies_A
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo PSinfo_300test_COIA.txt -x 3 -y 3 -p 3 -t 5 -l 300 -o Filter_min3PCRs_min5copies_A ;date
#2017年 4月29日 星期六 08时54分05秒 CST
#2017年 4月29日 星期六 09时56分39秒 CST
cd Filter_min3PCRs_min5copies_A
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna  ###260 OTU
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_A_96.txt -blast


cd B
mkdir Filter_min3PCRs_min2copies_B
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo PSinfo_300test_COIB.txt -x 3 -y 3 -p 3 -t 2 -l 300 -o Filter_min3PCRs_min2copies_B ;date
#2017年 4月19日 星期三 11时01分37秒 CST
#2017年 4月19日 星期三 11时39分20秒 CST
cd Filter_min3PCRs_min2copies_B
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna  ###305 OTU
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_A_96.txt -blast

mkdir Filter_min3PCRs_min1copies_B
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo PSinfo_300test_COIB.txt -x 3 -y 3 -p 3 -t 2 -l 300 -o Filter_min3PCRs_min1copies_B ;date
#2017年 4月19日 星期三 13时03分59秒 CST
#2017年 4月19日 星期三 13时44分00秒 CST
cd Filter_min3PCRs_min1copies_B
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna  ###305 OTU
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_A_96.txt -blast

mkdir Filter_min2PCRs_min2copies_B
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo PSinfo_300test_COIB.txt -x 3 -y 3 -p 3 -t 2 -l 300 -o Filter_min2PCRs_min2copies_B ;date
#2017年 4月19日 星期三 13时57分54秒 CST
#2017年 4月19日 星期三 14时38分28秒 CST
cd Filter_min2PCRs_min2copies_B
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna  ###305  OTU
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_A_96.txt -blast

mkdir Filter_min3PCRs_min5copies_B
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo PSinfo_300test_COIB.txt -x 3 -y 3 -p 3 -t 5 -l 300 -o Filter_min3PCRs_min5copies_B ;date
#2017年 4月29日 星期六 08时55分52秒 CST
#2017年 4月29日 星期六 09时53分55秒 CST
cd Filter_min3PCRs_min5copies_B
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna  ###266  OTU
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_A_96.txt -blast


cd C
mkdir Filter_min3PCRs_min2copies_C
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo PSinfo_300test_COIC.txt -x 3 -y 3 -p 3 -t 2 -l 300 -o Filter_min3PCRs_min2copies_C ;date
#2017年 4月20日 星期四 11时55分56秒 CST
#2017年 4月20日 星期四 12时39分56秒 CST
cd Filter_min2PCRs_min2copies_C
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna  ###281  OTU
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_A_96.txt -blast

mkdir Filter_min3PCRs_min5copies_C
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo PSinfo_300test_COIC.txt -x 3 -y 3 -p 3 -t 5 -l 300 -o Filter_min3PCRs_min5copies_C ;date
#2017年 4月29日 星期六 09时37分23秒 CST
#2017年 4月29日 星期六 10时30分18秒 CST
cd Filter_min3PCRs_min5copies_C
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna  ###248  OTU
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_A_96.txt -blast


cd D
mkdir Filter_min3PCRs_min2copies_D
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo PSinfo_300test_COID.txt -x 3 -y 3 -p 3 -t 2 -l 300 -o Filter_min3PCRs_min2copies_D ;date
2017年 4月21日 星期五 17时59分16秒 CST
2017年 4月21日 星期五 18时49分42秒 CST
cd Filter_min3PCRs_min2copies_D
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna  ###273  OTU
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_A_96.txt -blast

mkdir Filter_min3PCRs_min5copies_D
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo PSinfo_300test_COID.txt -x 3 -y 3 -p 3 -t 5 -l 300 -o Filter_min3PCRs_min5copies_D ;date
#2017年 4月29日 星期六 10时19分06秒 CST
#2017年 4月29日 星期六 11时12分21秒 CST
cd Filter_min3PCRs_min5copies_D
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320

cd E
mkdir Filter_min3PCRs_min2copies_E
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo PSinfo_300test_COIE.txt -x 3 -y 3 -p 3 -t 2 -l 300 -o Filter_min3PCRs_min2copies_E ;date
#2017年 4月21日 星期五 20时16分16秒 CST
#2017年 4月21日 星期五 20时51分48秒 CST
cd Filter_min3PCRs_min2copies_E
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna  ###302  OTU
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_A_96.txt -blast

mkdir Filter_min3PCRs_min5copies_E
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo PSinfo_300test_COIE.txt -x 3 -y 3 -p 3 -t 5 -l 300 -o Filter_min3PCRs_min5copies_E ;date


cd F
mkdir Filter_min3PCRs_min2copies_F
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo PSinfo_300test_COIF.txt -x 3 -y 3 -p 3 -t 2 -l 300 -o Filter_min3PCRs_min2copies_F ;date
#2017年 4月22日 星期六 13时51分56秒 CST
#2017年 4月22日 星期六 14时15分57秒 CST
cd Filter_min3PCRs_min2copies_F
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna  ###289  OTU
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_A_96.txt -blast

mkdir Filter_min3PCRs_min5copies_F
date; python /usr/local/bin/DAMe/bin/filter.py -psInfo PSinfo_300test_COIF.txt -x 3 -y 3 -p 3 -t 5 -l 300 -o Filter_min3PCRs_min5copies_F ;date
#2017年 4月29日 星期六 08时52分35秒 CST
#2017年 4月29日 星期六 09时27分47秒 CST
cd Filter_min3PCRs_min5copies_F
python /usr/local/bin/DAMe/bin/convertToUSearch.py -i FilteredReads.fna -lmin 300 -lmax 320
sumaclust -t 0.96 -e FilteredReads.forsumaclust.fna > OTUs_96_sumaclust.fna  ###248  OTU
python /usr/local/bin/DAMe/bin/tabulateSumaclust.py -i OTUs_96_sumaclust.fna -o table_300test_A_96.txt -blast





#####建立本地blast 数据库？？蔡望做
makeblastdb -in MTBallSpeciesSeqs_noYWK.fasta -dbtype nucl

usearch9 -sortbysize unidentified_OTU_B.fasta -fastaout unidentified_OTU_B_sorted.fasta

usearch9 -uchime2_ref unidentified_OTU_B.fasta -db MTBallSpeciesSeqs_noYWK.fasta -uchimeout out.txt -strand plus -mode sensitive

usearch9 -uchime2_denovo unidentified_OTU_B_sorted.fasta -chimeras denovo_chimeras9.fasta



############################################比较不同的Tag差异########################################
###Use the output “sickle_cor_panda_XX.fna”after "AdapterRemoval+Sickle+SPades+Pandaseq"###
###on QIIME
source /macqiime/configs/bash_profile.txt		### for using Macqiime

###PCR_A1
validate_mapping_file.py -m Mappingfile_A1.txt -o check_map/

#convert fastq file to fasta file.
convert_fastaqual_fastq.py -f sickle_cor_panda_A1.fastq -c fastq_to_fastaqual

date; split_libraries.py -m Mappingfile_A1.txt -f sickle_cor_panda_A1.fna -q sickle_cor_panda_A1.qual -o 2split_A1/ -l 300 -L 450 -b hamming_8 -r -t -d -z truncate_remove -s 20 -M 2 --reverse_primer_mismatches 2;date


###use seqtk looking for reverse matches
seqtk seq -r sickle_cor_panda_A1.fastq >sickle_cor_panda_A1_rc.fastq
convert_fastaqual_fastq.py -f sickle_cor_panda_A1_rc.fastq -c fastq_to_fastaqual
date; split_libraries.py -m Mappingfile_A1.txt -f sickle_cor_panda_A1_rc.fna -q sickle_cor_panda_A1_rc.qual -o 2split_A1_rc/ -l 300 -L 450 -b hamming_8 -r -t -d -z truncate_remove -s 20 -M 2 --reverse_primer_mismatches 2 -n 2464;date


#########################################比较不同的Tag差异，用Wang Xiaoyang的perl程序####################
#程序名称：300Test_extractAllreadsfromSort.pl
#Author: Wang Xiaoyang
#Aim: put all seqs from different pools into one single fasta file.

perl 300Test_extractAllreadsfromSort.pl -id AF_Folder/ -o AF_allseqs.fasta

#########################################uchime to remove chimera################################

date; usearch9 -fastx_uniques AF_allseqs.fasta -fastaout AF_allseqs_uniques.fasta -sizeout -relabel unique -uc unique.uc; date
###1390945 uniques.  1205789 singleton reads (86.7%)

###     just used unique.uc file; put uc.files into one folder--uc
perl Pick_cluster_num_V3.pl -id uc/ -o usearch9_map.txt		## added function for getting size of each unique seq

### pick rep seqs
date; pick_rep_set.py -i usearch9_map.txt -f AF_allseqs.fasta -o usearch_dereped.fasta -m most_abundant; date
2017年 7月12日 星期三 11时56分16秒 CST
2017年 7月12日 星期三 12时03分53秒 CST

### deChimera

#uchime2 with unique sequences
less usearch_dereped.fasta | tr ' ' ';' > usearch_dereped9.fasta   ###replace' 'with';'
usearch9 -sortbysize usearch_dereped9.fasta -fastaout usearch_dereped9_sorted.fasta
# if run on mac
date; usearch9 -uchime2_denovo usearch_dereped9_sorted.fasta -chimeras denovo_chimeras9.fasta -nonchimeras denovo_nonchimeras9.fasta; date  # if run on mac.

# if run on server
ssh wangxy@10.0.16.80
kiz650223
cd Yahan
screen
date; ~/scripts/usearch/usearch9.2.64_i86linux32 -uchime2_denovo usearch_dereped9_sorted.fasta -chimeras denovo_chimeras9.fasta  -nonchimeras denovo_nonchimeras9.fasta; date
# ctrl-a d  # type this into the terminal
screen -r 15693

# uchime2 without unique sequences
# create a fasta file without singleton reads (unique reads)
~/scripts/usearch/usearch9.2.64_i86linux32 -sortbysize usearch_dereped9_sorted.fasta -fastaout usearch_dereped9_sorted_nouniques.fasta -minsize 2
# usearch -fastx_uniques input.fasta -fastaout uniques.fasta -minuniquesize 2 -sizeout # alternative method
# ./usearch10 -fastx_info usearch_dereped9_sorted_nouniques.fasta
# File size 77.6M, 215.6k seqs, 67.4M letters
# Lengths min 15, low 312, med 313, hi 313, max 442
# Letter freqs T 38.7%, A 28.9%, C 18.4%, G 14.0%
# 0% masked (lower-case)

screen
date; ~/scripts/usearch/usearch9.2.64_i86linux32 -uchime2_denovo usearch_dereped9_sorted_nouniques.fasta -chimeras denovo_nouniques_chimeras9.fasta  -nonchimeras denovo_nouniques_nonchimeras9.fasta; date
# ctrl-a d  # type this into the terminal
screen -r 15791
